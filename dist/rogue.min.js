!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){var d=a("./rot.js"),e={display:null,map:{},engine:null,player:null,pedro:null,ananas:null,init:function(){this.display=new d.Display({spacing:1.1}),document.body.appendChild(this.display.getContainer()),this._generateMap();var a=new d.Scheduler.Simple;a.add(this.player,!0),a.add(this.pedro,!0),this.engine=new d.Engine(a),this.engine.start()},_generateMap:function(){var a=new d.Map.Digger,b=[],c=function(a,c,d){if(!d){var e=a+","+c;this.map[e]=".",b.push(e)}};a.create(c.bind(this)),this._generateBoxes(b),this._drawWholeMap(),this.player=this._createBeing(f,b),this.pedro=this._createBeing(g,b)},_createBeing:function(a,b){var c=Math.floor(d.RNG.getUniform()*b.length),e=b.splice(c,1)[0],f=e.split(","),g=parseInt(f[0]),h=parseInt(f[1]);return new a(g,h)},_generateBoxes:function(a){for(var b=0;10>b;b++){var c=Math.floor(d.RNG.getUniform()*a.length),e=a.splice(c,1)[0];this.map[e]="*",b||(this.ananas=e)}},_drawWholeMap:function(){for(var a in this.map){var b=a.split(","),c=parseInt(b[0]),d=parseInt(b[1]);this.display.draw(c,d,this.map[a])}}},f=function(a,b){this._x=a,this._y=b,this._draw()};f.prototype.getSpeed=function(){return 100},f.prototype.getX=function(){return this._x},f.prototype.getY=function(){return this._y},f.prototype.act=function(){e.engine.lock(),window.addEventListener("keydown",this)},f.prototype.handleEvent=function(a){var b=a.keyCode;if(13==b||32==b)return void this._checkBox();var c={};if(c[38]=0,c[33]=1,c[39]=2,c[34]=3,c[40]=4,c[35]=5,c[37]=6,c[36]=7,b in c){var f=d.DIRS[8][c[b]],g=this._x+f[0],h=this._y+f[1],i=g+","+h;i in e.map&&(e.display.draw(this._x,this._y,e.map[this._x+","+this._y]),this._x=g,this._y=h,this._draw(),window.removeEventListener("keydown",this),e.engine.unlock())}},f.prototype._draw=function(){e.display.draw(this._x,this._y,"@","#ff0")},f.prototype._checkBox=function(){var a=this._x+","+this._y;"*"!=e.map[a]?alert("There is no box here!"):a==e.ananas?(alert("Hooray! You found an ananas and won this game."),e.engine.lock(),window.removeEventListener("keydown",this)):alert("This box is empty :-(")};var g=function(a,b){this._x=a,this._y=b,this._draw()};g.prototype.getSpeed=function(){return 100},g.prototype.act=function(){var a=e.player.getX(),b=e.player.getY(),c=function(a,b){return a+","+b in e.map},f=new d.Path.AStar(a,b,c,{topology:4}),g=[],h=function(a,b){g.push([a,b])};f.compute(this._x,this._y,h),g.shift(),1==g.length?(e.engine.lock(),alert("Game over - you were captured by Pedro!")):(a=g[0][0],b=g[0][1],e.display.draw(this._x,this._y,e.map[this._x+","+this._y]),this._x=a,this._y=b,this._draw())},g.prototype._draw=function(){e.display.draw(this._x,this._y,"P","red")},e.init()},{"./rot.js":2}],2:[function(a,b,c){var d={isSupported:function(){return!(!document.createElement("canvas").getContext||!Function.prototype.bind)},DEFAULT_WIDTH:80,DEFAULT_HEIGHT:25,DIRS:{4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95};d.Text={RE_COLORS:/%([bc]){([^}]*)}/g,TYPE_TEXT:0,TYPE_NEWLINE:1,TYPE_FG:2,TYPE_BG:3,measure:function(a,b){for(var c={width:0,height:1},d=this.tokenize(a,b),e=0,f=0;f<d.length;f++){var g=d[f];switch(g.type){case this.TYPE_TEXT:e+=g.value.length;break;case this.TYPE_NEWLINE:c.height++,c.width=Math.max(c.width,e),e=0}}return c.width=Math.max(c.width,e),c},tokenize:function(a,b){var c=[],e=0;a.replace(this.RE_COLORS,function(b,f,g,h){var i=a.substring(e,h);return i.length&&c.push({type:d.Text.TYPE_TEXT,value:i}),c.push({type:"c"==f?d.Text.TYPE_FG:d.Text.TYPE_BG,value:g.trim()}),e=h+b.length,""});var f=a.substring(e);return f.length&&c.push({type:d.Text.TYPE_TEXT,value:f}),this._breakLines(c,b)},_breakLines:function(a,b){b||(b=1/0);for(var c=0,e=0,f=-1;c<a.length;){var g=a[c];if(g.type==d.Text.TYPE_NEWLINE&&(e=0,f=-1),g.type==d.Text.TYPE_TEXT){for(;0==e&&" "==g.value.charAt(0);)g.value=g.value.substring(1);var h=g.value.indexOf("\n");if(-1!=h){g.value=this._breakInsideToken(a,c,h,!0);for(var i=g.value.split("");i.length&&" "==i[i.length-1];)i.pop();g.value=i.join("")}if(g.value.length){if(e+g.value.length>b){for(var h=-1;;){var j=g.value.indexOf(" ",h+1);if(-1==j)break;if(e+j>b)break;h=j}if(-1!=h)g.value=this._breakInsideToken(a,c,h,!0);else if(-1!=f){var g=a[f],k=g.value.lastIndexOf(" ");g.value=this._breakInsideToken(a,f,k,!0),c=f}else g.value=this._breakInsideToken(a,c,b-e,!1)}else e+=g.value.length,-1!=g.value.indexOf(" ")&&(f=c);c++}else a.splice(c,1)}else c++}a.push({type:d.Text.TYPE_NEWLINE});for(var l=null,c=0;c<a.length;c++){var g=a[c];switch(g.type){case d.Text.TYPE_TEXT:l=g;break;case d.Text.TYPE_NEWLINE:if(l){for(var i=l.value.split("");i.length&&" "==i[i.length-1];)i.pop();l.value=i.join("")}l=null}}return a.pop(),a},_breakInsideToken:function(a,b,c,e){var f={type:d.Text.TYPE_NEWLINE},g={type:d.Text.TYPE_TEXT,value:a[b].value.substring(c+(e?1:0))};return a.splice(b+1,0,f,g),a[b].value.substring(0,c)}},Array.prototype.random=Array.prototype.random||function(){return this.length?this[Math.floor(d.RNG.getUniform()*this.length)]:null},Array.prototype.randomize=Array.prototype.randomize||function(){for(var a=[];this.length;){var b=this.indexOf(this.random());a.push(this.splice(b,1)[0])}return a},Number.prototype.mod=Number.prototype.mod||function(a){return(this%a+a)%a},String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)},String.prototype.lpad=String.prototype.lpad||function(a,b){for(var c=a||"0",d=b||2,e="";e.length<d-this.length;)e+=c;return e=e.substring(0,d-this.length),e+this},String.prototype.rpad=String.prototype.rpad||function(a,b){for(var c=a||"0",d=b||2,e="";e.length<d-this.length;)e+=c;return e=e.substring(0,d-this.length),this+e},String.format=String.format||function(a){var b=String.format.map,c=Array.prototype.slice.call(arguments,1),d=function(d,e,f,g){if("%"==a.charAt(g-1))return d.substring(1);if(!c.length)return d;var h=c[0],i=e||f,j=i.split(","),k=j.shift(),l=b[k.toLowerCase()];if(!l)return d;var h=c.shift(),m=h[l].apply(h,j),n=k.charAt(0);return n!=n.toLowerCase()&&(m=m.capitalize()),m};return a.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,d)},String.format.map=String.format.map||{s:"toString"},String.prototype.format=String.prototype.format||function(){var a=Array.prototype.slice.call(arguments);return a.unshift(this),String.format.apply(String,a)},Object.create||(Object.create=function(a){var b=function(){};return b.prototype=a,new b}),Function.prototype.extend=Function.prototype.extend||function(a){return this.prototype=Object.create(a.prototype),this.prototype.constructor=this,this},"undefined"!=typeof window&&(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){return setTimeout(a,1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(a){return clearTimeout(a)}),d.Display=function(a){var b=document.createElement("canvas");this._context=b.getContext("2d"),this._data={},this._dirty=!1,this._options={},this._backend=null;var c={width:d.DEFAULT_WIDTH,height:d.DEFAULT_HEIGHT,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1,termColor:"xterm"};for(var e in a)c[e]=a[e];this.setOptions(c),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),requestAnimationFrame(this._tick)},d.Display.prototype.DEBUG=function(a,b,c){var d=[this._options.bg,this._options.fg];this.draw(a,b,null,null,d[c%d.length])},d.Display.prototype.clear=function(){this._data={},this._dirty=!0},d.Display.prototype.setOptions=function(a){for(var b in a)this._options[b]=a[b];if(a.width||a.height||a.fontSize||a.fontFamily||a.spacing||a.layout){a.layout&&(this._backend=new(d.Display[a.layout.capitalize()])(this._context));var c=(this._options.fontStyle?this._options.fontStyle+" ":"")+this._options.fontSize+"px "+this._options.fontFamily;this._context.font=c,this._backend.compute(this._options),this._context.font=c,this._context.textAlign="center",this._context.textBaseline="middle",this._dirty=!0}return this},d.Display.prototype.getOptions=function(){return this._options},d.Display.prototype.getContainer=function(){return this._context.canvas},d.Display.prototype.computeSize=function(a,b){return this._backend.computeSize(a,b,this._options)},d.Display.prototype.computeFontSize=function(a,b){return this._backend.computeFontSize(a,b,this._options)},d.Display.prototype.eventToPosition=function(a){if(a.touches)var b=a.touches[0].clientX,c=a.touches[0].clientY;else var b=a.clientX,c=a.clientY;var d=this._context.canvas.getBoundingClientRect();return b-=d.left,c-=d.top,0>b||0>c||b>=this._context.canvas.width||c>=this._context.canvas.height?[-1,-1]:this._backend.eventToPosition(b,c)},d.Display.prototype.draw=function(a,b,c,d,e){d||(d=this._options.fg),e||(e=this._options.bg),this._data[a+","+b]=[a,b,c,d,e],this._dirty!==!0&&(this._dirty||(this._dirty={}),this._dirty[a+","+b]=!0)},d.Display.prototype.drawText=function(a,b,c,e){var f=null,g=null,h=a,i=b,j=1;e||(e=this._options.width-a);for(var k=d.Text.tokenize(c,e);k.length;){var l=k.shift();switch(l.type){case d.Text.TYPE_TEXT:for(var m=!1,n=!1,o=!1,p=!1,q=0;q<l.value.length;q++){var r=l.value.charCodeAt(q),s=l.value.charAt(q);o=r>255&&65377>r||r>65500&&65512>r&&r>65518,m=32==s.charCodeAt(0)||12288==s.charCodeAt(0),!p||o||m||h++,o&&!n&&h++,this.draw(h++,i,s,f,g),n=m,p=o}break;case d.Text.TYPE_FG:f=l.value||null;break;case d.Text.TYPE_BG:g=l.value||null;break;case d.Text.TYPE_NEWLINE:h=a,i++,j++}}return j},d.Display.prototype._tick=function(){if(requestAnimationFrame(this._tick),this._dirty){if(this._dirty===!0){this._context.fillStyle=this._options.bg,this._context.fillRect(0,0,this._context.canvas.width,this._context.canvas.height);for(var a in this._data)this._draw(a,!1)}else for(var b in this._dirty)this._draw(b,!0);this._dirty=!1}},d.Display.prototype._draw=function(a,b){var c=this._data[a];c[4]!=this._options.bg&&(b=!0),this._backend.draw(c,b)},d.Display.Backend=function(a){this._context=a},d.Display.Backend.prototype.compute=function(a){},d.Display.Backend.prototype.draw=function(a,b){},d.Display.Backend.prototype.computeSize=function(a,b){},d.Display.Backend.prototype.computeFontSize=function(a,b){},d.Display.Backend.prototype.eventToPosition=function(a,b){},d.Display.Rect=function(a){d.Display.Backend.call(this,a),this._spacingX=0,this._spacingY=0,this._canvasCache={},this._options={}},d.Display.Rect.extend(d.Display.Backend),d.Display.Rect.cache=!1,d.Display.Rect.prototype.compute=function(a){this._canvasCache={},this._options=a;var b=Math.ceil(this._context.measureText("W").width);this._spacingX=Math.ceil(a.spacing*b),this._spacingY=Math.ceil(a.spacing*a.fontSize),this._options.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._context.canvas.width=a.width*this._spacingX,this._context.canvas.height=a.height*this._spacingY},d.Display.Rect.prototype.draw=function(a,b){this.constructor.cache?this._drawWithCache(a,b):this._drawNoCache(a,b)},d.Display.Rect.prototype._drawWithCache=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=""+e+f+g;if(h in this._canvasCache)var i=this._canvasCache[h];else{var j=this._options.border,i=document.createElement("canvas"),k=i.getContext("2d");if(i.width=this._spacingX,i.height=this._spacingY,k.fillStyle=g,k.fillRect(j,j,i.width-j,i.height-j),e){k.fillStyle=f,k.font=this._context.font,k.textAlign="center",k.textBaseline="middle";for(var l=[].concat(e),m=0;m<l.length;m++)k.fillText(l[m],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[h]=i}this._context.drawImage(i,c*this._spacingX,d*this._spacingY)},d.Display.Rect.prototype._drawNoCache=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4];if(b){var h=this._options.border;this._context.fillStyle=g,this._context.fillRect(c*this._spacingX+h,d*this._spacingY+h,this._spacingX-h,this._spacingY-h)}if(e){this._context.fillStyle=f;for(var i=[].concat(e),j=0;j<i.length;j++)this._context.fillText(i[j],(c+.5)*this._spacingX,Math.ceil((d+.5)*this._spacingY))}},d.Display.Rect.prototype.computeSize=function(a,b){var c=Math.floor(a/this._spacingX),d=Math.floor(b/this._spacingY);return[c,d]},d.Display.Rect.prototype.computeFontSize=function(a,b){var c=Math.floor(a/this._options.width),d=Math.floor(b/this._options.height),e=this._context.font;this._context.font="100px "+this._options.fontFamily;var f=Math.ceil(this._context.measureText("W").width);this._context.font=e;var g=f/100,h=g*d/c;return h>1&&(d=Math.floor(d/h)),Math.floor(d/this._options.spacing)},d.Display.Rect.prototype.eventToPosition=function(a,b){return[Math.floor(a/this._spacingX),Math.floor(b/this._spacingY)]},d.Display.Hex=function(a){d.Display.Backend.call(this,a),this._spacingX=0,this._spacingY=0,this._hexSize=0,this._options={}},d.Display.Hex.extend(d.Display.Backend),d.Display.Hex.prototype.compute=function(a){this._options=a;var b=Math.ceil(this._context.measureText("W").width);if(this._hexSize=Math.floor(a.spacing*(a.fontSize+b/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,a.transpose)var c="height",d="width";else var c="width",d="height";this._context.canvas[c]=Math.ceil((a.width+1)*this._spacingX),this._context.canvas[d]=Math.ceil((a.height-1)*this._spacingY+2*this._hexSize)},d.Display.Hex.prototype.draw=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=[(c+1)*this._spacingX,d*this._spacingY+this._hexSize];if(this._options.transpose&&h.reverse(),b&&(this._context.fillStyle=g,this._fill(h[0],h[1])),e){this._context.fillStyle=f;for(var i=[].concat(e),j=0;j<i.length;j++)this._context.fillText(i[j],h[0],Math.ceil(h[1]))}},d.Display.Hex.prototype.computeSize=function(a,b){this._options.transpose&&(a+=b,b=a-b,a-=b);var c=Math.floor(a/this._spacingX)-1,d=Math.floor((b-2*this._hexSize)/this._spacingY+1);return[c,d]},d.Display.Hex.prototype.computeFontSize=function(a,b){this._options.transpose&&(a+=b,b=a-b,a-=b);var c=2*a/((this._options.width+1)*Math.sqrt(3))-1,d=b/(2+1.5*(this._options.height-1)),e=Math.min(c,d),f=this._context.font;this._context.font="100px "+this._options.fontFamily;var g=Math.ceil(this._context.measureText("W").width);this._context.font=f;var h=g/100;e=Math.floor(e)+1;var i=2*e/(this._options.spacing*(1+h/Math.sqrt(3)));return Math.ceil(i)-1},d.Display.Hex.prototype.eventToPosition=function(a,b){if(this._options.transpose){a+=b,b=a-b,a-=b;var c="width"}else var c="height";var d=this._context.canvas[c]/this._options[c];return b=Math.floor(b/d),b.mod(2)?(a-=this._spacingX,a=1+2*Math.floor(a/(2*this._spacingX))):a=2*Math.floor(a/(2*this._spacingX)),[a,b]},d.Display.Hex.prototype._fill=function(a,b){var c=this._hexSize,d=this._options.border;this._context.beginPath(),this._options.transpose?(this._context.moveTo(a-c+d,b),this._context.lineTo(a-c/2+d,b+this._spacingX-d),this._context.lineTo(a+c/2-d,b+this._spacingX-d),this._context.lineTo(a+c-d,b),this._context.lineTo(a+c/2-d,b-this._spacingX+d),this._context.lineTo(a-c/2+d,b-this._spacingX+d),this._context.lineTo(a-c+d,b)):(this._context.moveTo(a,b-c+d),this._context.lineTo(a+this._spacingX-d,b-c/2+d),this._context.lineTo(a+this._spacingX-d,b+c/2-d),this._context.lineTo(a,b+c-d),this._context.lineTo(a-this._spacingX+d,b+c/2-d),this._context.lineTo(a-this._spacingX+d,b-c/2+d),this._context.lineTo(a,b-c+d)),this._context.fill()},d.Display.Tile=function(a){d.Display.Rect.call(this,a),this._options={},this._colorCanvas=document.createElement("canvas")},d.Display.Tile.extend(d.Display.Rect),d.Display.Tile.prototype.compute=function(a){this._options=a,this._context.canvas.width=a.width*a.tileWidth,this._context.canvas.height=a.height*a.tileHeight,this._colorCanvas.width=a.tileWidth,this._colorCanvas.height=a.tileHeight},d.Display.Tile.prototype.draw=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=this._options.tileWidth,i=this._options.tileHeight;if(b&&(this._options.tileColorize?this._context.clearRect(c*h,d*i,h,i):(this._context.fillStyle=g,this._context.fillRect(c*h,d*i,h,i))),e)for(var j=[].concat(e),k=0;k<j.length;k++){var l=this._options.tileMap[j[k]];if(!l)throw new Error("Char '"+j[k]+"' not found in tileMap");if(this._options.tileColorize){var m=this._colorCanvas,n=m.getContext("2d");n.clearRect(0,0,h,i),n.drawImage(this._options.tileSet,l[0],l[1],h,i,0,0,h,i),"transparent"!=f&&(n.fillStyle=f,n.globalCompositeOperation="source-atop",n.fillRect(0,0,h,i)),"transparent"!=g&&(n.fillStyle=g,n.globalCompositeOperation="destination-over",n.fillRect(0,0,h,i)),this._context.drawImage(m,c*h,d*i,h,i)}else this._context.drawImage(this._options.tileSet,l[0],l[1],h,i,c*h,d*i,h,i)}},d.Display.Tile.prototype.computeSize=function(a,b){var c=Math.floor(a/this._options.tileWidth),d=Math.floor(b/this._options.tileHeight);return[c,d]},d.Display.Tile.prototype.computeFontSize=function(a,b){var c=Math.floor(a/this._options.width),d=Math.floor(b/this._options.height);return[c,d]},d.Display.Tile.prototype.eventToPosition=function(a,b){return[Math.floor(a/this._options.tileWidth),Math.floor(b/this._options.tileHeight)]},d.RNG={getSeed:function(){return this._seed},setSeed:function(a){return a=1>a?1/a:a,this._seed=a,this._s0=(a>>>0)*this._frac,a=69069*a+1>>>0,this._s1=a*this._frac,a=69069*a+1>>>0,this._s2=a*this._frac,this._c=1,this},getUniform:function(){var a=2091639*this._s0+this._c*this._frac;return this._s0=this._s1,this._s1=this._s2,this._c=0|a,this._s2=a-this._c,this._s2},getUniformInt:function(a,b){var c=Math.max(a,b),d=Math.min(a,b);return Math.floor(this.getUniform()*(c-d+1))+d},getNormal:function(a,b){do var c=2*this.getUniform()-1,d=2*this.getUniform()-1,e=c*c+d*d;while(e>1||0==e);var f=c*Math.sqrt(-2*Math.log(e)/e);return(a||0)+f*(b||1)},getPercentage:function(){return 1+Math.floor(100*this.getUniform())},getWeightedValue:function(a){var b=0;for(var c in a)b+=a[c];var d=this.getUniform()*b,e=0;for(var c in a)if(e+=a[c],e>d)return c;return c},getState:function(){return[this._s0,this._s1,this._s2,this._c]},setState:function(a){return this._s0=a[0],this._s1=a[1],this._s2=a[2],this._c=a[3],this},clone:function(){var a=Object.create(this);return a.setState(this.getState()),a},_s0:0,_s1:0,_s2:0,_c:0,_frac:2.3283064365386963e-10},d.RNG.setSeed(Date.now()),d.StringGenerator=function(a){this._options={words:!1,order:3,prior:.001};for(var b in a)this._options[b]=a[b];this._boundary=String.fromCharCode(0),this._suffix=this._boundary,this._prefix=[];for(var c=0;c<this._options.order;c++)this._prefix.push(this._boundary);this._priorValues={},this._priorValues[this._boundary]=this._options.prior,this._data={}},d.StringGenerator.prototype.clear=function(){this._data={},this._priorValues={}},d.StringGenerator.prototype.generate=function(){for(var a=[this._sample(this._prefix)];a[a.length-1]!=this._boundary;)a.push(this._sample(a));return this._join(a.slice(0,-1))},d.StringGenerator.prototype.observe=function(a){for(var b=this._split(a),c=0;c<b.length;c++)this._priorValues[b[c]]=this._options.prior;b=this._prefix.concat(b).concat(this._suffix);for(var c=this._options.order;c<b.length;c++)for(var d=b.slice(c-this._options.order,c),e=b[c],f=0;f<d.length;f++){var g=d.slice(f);this._observeEvent(g,e)}},d.StringGenerator.prototype.getStats=function(){var a=[],b=0;for(var c in this._priorValues)b++;b--,a.push("distinct samples: "+b);var d=0,e=0;for(var c in this._data){d++;for(var f in this._data[c])e++}return a.push("dictionary size (contexts): "+d),a.push("dictionary size (events): "+e),a.join(", ")},d.StringGenerator.prototype._split=function(a){return a.split(this._options.words?/\s+/:"")},d.StringGenerator.prototype._join=function(a){return a.join(this._options.words?" ":"")},d.StringGenerator.prototype._observeEvent=function(a,b){var c=this._join(a);c in this._data||(this._data[c]={});var d=this._data[c];b in d||(d[b]=0),d[b]++},d.StringGenerator.prototype._sample=function(a){a=this._backoff(a);var b=this._join(a),c=this._data[b],e={};if(this._options.prior){for(var f in this._priorValues)e[f]=this._priorValues[f];for(var f in c)e[f]+=c[f]}else e=c;return d.RNG.getWeightedValue(e)},d.StringGenerator.prototype._backoff=function(a){for(a.length>this._options.order?a=a.slice(-this._options.order):a.length<this._options.order&&(a=this._prefix.slice(0,this._options.order-a.length).concat(a));!(this._join(a)in this._data)&&a.length>0;)a=a.slice(1);return a},d.EventQueue=function(){this._time=0,this._events=[],this._eventTimes=[]},d.EventQueue.prototype.getTime=function(){return this._time},d.EventQueue.prototype.clear=function(){return this._events=[],this._eventTimes=[],this},d.EventQueue.prototype.add=function(a,b){for(var c=this._events.length,d=0;d<this._eventTimes.length;d++)if(this._eventTimes[d]>b){c=d;break}this._events.splice(c,0,a),this._eventTimes.splice(c,0,b)},d.EventQueue.prototype.get=function(){if(!this._events.length)return null;var a=this._eventTimes.splice(0,1)[0];if(a>0){this._time+=a;for(var b=0;b<this._eventTimes.length;b++)this._eventTimes[b]-=a}return this._events.splice(0,1)[0]},d.EventQueue.prototype.remove=function(a){var b=this._events.indexOf(a);return-1==b?!1:(this._remove(b),!0)},d.EventQueue.prototype._remove=function(a){this._events.splice(a,1),this._eventTimes.splice(a,1)},d.Scheduler=function(){this._queue=new d.EventQueue,this._repeat=[],this._current=null},d.Scheduler.prototype.getTime=function(){return this._queue.getTime()},d.Scheduler.prototype.add=function(a,b){return b&&this._repeat.push(a),this},d.Scheduler.prototype.clear=function(){return this._queue.clear(),this._repeat=[],this._current=null,this},d.Scheduler.prototype.remove=function(a){var b=this._queue.remove(a),c=this._repeat.indexOf(a);return-1!=c&&this._repeat.splice(c,1),this._current==a&&(this._current=null),b},d.Scheduler.prototype.next=function(){return this._current=this._queue.get(),this._current},d.Scheduler.Simple=function(){d.Scheduler.call(this)},d.Scheduler.Simple.extend(d.Scheduler),d.Scheduler.Simple.prototype.add=function(a,b){return this._queue.add(a,0),d.Scheduler.prototype.add.call(this,a,b)},d.Scheduler.Simple.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),d.Scheduler.prototype.next.call(this)},d.Scheduler.Speed=function(){d.Scheduler.call(this)},d.Scheduler.Speed.extend(d.Scheduler),d.Scheduler.Speed.prototype.add=function(a,b){return this._queue.add(a,1/a.getSpeed()),d.Scheduler.prototype.add.call(this,a,b)},d.Scheduler.Speed.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed()),d.Scheduler.prototype.next.call(this)},d.Scheduler.Action=function(){d.Scheduler.call(this),this._defaultDuration=1,this._duration=this._defaultDuration},d.Scheduler.Action.extend(d.Scheduler),d.Scheduler.Action.prototype.add=function(a,b,c){return this._queue.add(a,c||this._defaultDuration),d.Scheduler.prototype.add.call(this,a,b)},d.Scheduler.Action.prototype.clear=function(){return this._duration=this._defaultDuration,d.Scheduler.prototype.clear.call(this)},d.Scheduler.Action.prototype.remove=function(a){return a==this._current&&(this._duration=this._defaultDuration),d.Scheduler.prototype.remove.call(this,a)},d.Scheduler.Action.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),d.Scheduler.prototype.next.call(this)},d.Scheduler.Action.prototype.setDuration=function(a){return this._current&&(this._duration=a),this},d.Engine=function(a){this._scheduler=a,this._lock=1},d.Engine.prototype.start=function(){return this.unlock()},d.Engine.prototype.lock=function(){return this._lock++,this},d.Engine.prototype.unlock=function(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){var a=this._scheduler.next();if(!a)return this.lock();var b=a.act();b&&b.then&&(this.lock(),b.then(this.unlock.bind(this)))}return this},d.Map=function(a,b){this._width=a||d.DEFAULT_WIDTH,this._height=b||d.DEFAULT_HEIGHT},d.Map.prototype.create=function(a){},d.Map.prototype._fillMap=function(a){for(var b=[],c=0;c<this._width;c++){b.push([]);for(var d=0;d<this._height;d++)b[c].push(a)}return b},d.Map.Arena=function(a,b){d.Map.call(this,a,b)},d.Map.Arena.extend(d.Map),d.Map.Arena.prototype.create=function(a){for(var b=this._width-1,c=this._height-1,d=0;b>=d;d++)for(var e=0;c>=e;e++){var f=d&&e&&b>d&&c>e;a(d,e,f?0:1)}return this},d.Map.DividedMaze=function(a,b){d.Map.call(this,a,b),this._stack=[]},d.Map.DividedMaze.extend(d.Map),d.Map.DividedMaze.prototype.create=function(a){var b=this._width,c=this._height;this._map=[];for(var d=0;b>d;d++){this._map.push([]);for(var e=0;c>e;e++){var f=0==d||0==e||d+1==b||e+1==c;this._map[d].push(f?1:0)}}this._stack=[[1,1,b-2,c-2]],this._process();for(var d=0;b>d;d++)for(var e=0;c>e;e++)a(d,e,this._map[d][e]);return this._map=null,this},d.Map.DividedMaze.prototype._process=function(){for(;this._stack.length;){var a=this._stack.shift();this._partitionRoom(a)}},d.Map.DividedMaze.prototype._partitionRoom=function(a){for(var b=[],c=[],d=a[0]+1;d<a[2];d++){var e=this._map[d][a[1]-1],f=this._map[d][a[3]+1];!e||!f||d%2||b.push(d)}for(var g=a[1]+1;g<a[3];g++){var h=this._map[a[0]-1][g],i=this._map[a[2]+1][g];!h||!i||g%2||c.push(g)}if(b.length&&c.length){var j=b.random(),k=c.random();this._map[j][k]=1;var l=[],m=[];l.push(m);for(var d=a[0];j>d;d++)this._map[d][k]=1,m.push([d,k]);var m=[];l.push(m);for(var d=j+1;d<=a[2];d++)this._map[d][k]=1,m.push([d,k]);var m=[];l.push(m);for(var g=a[1];k>g;g++)this._map[j][g]=1,m.push([j,g]);var m=[];l.push(m);for(var g=k+1;g<=a[3];g++)this._map[j][g]=1,m.push([j,g]);for(var n=l.random(),d=0;d<l.length;d++){var m=l[d];if(m!=n){var o=m.random();this._map[o[0]][o[1]]=0}}this._stack.push([a[0],a[1],j-1,k-1]),this._stack.push([j+1,a[1],a[2],k-1]),this._stack.push([a[0],k+1,j-1,a[3]]),this._stack.push([j+1,k+1,a[2],a[3]])}},d.Map.IceyMaze=function(a,b,c){d.Map.call(this,a,b),this._regularity=c||0},d.Map.IceyMaze.extend(d.Map),d.Map.IceyMaze.prototype.create=function(a){var b=this._width,c=this._height,e=this._fillMap(1);b-=b%2?1:2,c-=c%2?1:2;var f=0,g=0,h=0,i=0,j=0,k=!1,l=[[0,0],[0,0],[0,0],[0,0]];do if(f=1+2*Math.floor(d.RNG.getUniform()*(b-1)/2),g=1+2*Math.floor(d.RNG.getUniform()*(c-1)/2),j||(e[f][g]=0),!e[f][g]){this._randomize(l);do{0==Math.floor(d.RNG.getUniform()*(this._regularity+1))&&this._randomize(l),k=!0;for(var m=0;4>m;m++)if(h=f+2*l[m][0],i=g+2*l[m][1],this._isFree(e,h,i,b,c)){e[h][i]=0,e[f+l[m][0]][g+l[m][1]]=0,f=h,g=i,k=!1,j++;break}}while(!k)}while(b*c/4>j+1);for(var m=0;m<this._width;m++)for(var n=0;n<this._height;n++)a(m,n,e[m][n]);return this._map=null,this},d.Map.IceyMaze.prototype._randomize=function(a){for(var b=0;4>b;b++)a[b][0]=0,a[b][1]=0;switch(Math.floor(4*d.RNG.getUniform())){case 0:a[0][0]=-1,a[1][0]=1,a[2][1]=-1,a[3][1]=1;break;case 1:a[3][0]=-1,a[2][0]=1,a[1][1]=-1,a[0][1]=1;break;case 2:a[2][0]=-1,a[3][0]=1,a[0][1]=-1,a[1][1]=1;break;case 3:a[1][0]=-1,a[0][0]=1,a[3][1]=-1,a[2][1]=1}},d.Map.IceyMaze.prototype._isFree=function(a,b,c,d,e){return 1>b||1>c||b>=d||c>=e?!1:a[b][c]},d.Map.EllerMaze=function(a,b){d.Map.call(this,a,b)},d.Map.EllerMaze.extend(d.Map),d.Map.EllerMaze.prototype.create=function(a){for(var b=this._fillMap(1),c=Math.ceil((this._width-2)/2),e=.375,f=[],g=[],h=0;c>h;h++)f.push(h),g.push(h);f.push(c-1);for(var i=1;i+3<this._height;i+=2)for(var h=0;c>h;h++){var j=2*h+1,k=i;b[j][k]=0,h!=f[h+1]&&d.RNG.getUniform()>e&&(this._addToList(h,f,g),b[j+1][k]=0),h!=f[h]&&d.RNG.getUniform()>e?this._removeFromList(h,f,g):b[j][k+1]=0}for(var h=0;c>h;h++){var j=2*h+1,k=i;b[j][k]=0,h!=f[h+1]&&(h==f[h]||d.RNG.getUniform()>e)&&(this._addToList(h,f,g),b[j+1][k]=0),this._removeFromList(h,f,g)}for(var h=0;h<this._width;h++)for(var i=0;i<this._height;i++)a(h,i,b[h][i]);return this},d.Map.EllerMaze.prototype._removeFromList=function(a,b,c){c[b[a]]=c[a],b[c[a]]=b[a],c[a]=a,b[a]=a},d.Map.EllerMaze.prototype._addToList=function(a,b,c){c[b[a+1]]=c[a],b[c[a]]=b[a+1],c[a]=a+1,b[a+1]=a},d.Map.Cellular=function(a,b,c){d.Map.call(this,a,b),this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8,connected:!1},this.setOptions(c),this._dirs=d.DIRS[this._options.topology],this._map=this._fillMap(0)},d.Map.Cellular.extend(d.Map),d.Map.Cellular.prototype.randomize=function(a){for(var b=0;b<this._width;b++)for(var c=0;c<this._height;c++)this._map[b][c]=d.RNG.getUniform()<a?1:0;return this},d.Map.Cellular.prototype.setOptions=function(a){for(var b in a)this._options[b]=a[b]},d.Map.Cellular.prototype.set=function(a,b,c){this._map[a][b]=c},d.Map.Cellular.prototype.create=function(a){for(var b=this._fillMap(0),c=this._options.born,d=this._options.survive,e=0;e<this._height;e++){var f=1,g=0;6==this._options.topology&&(f=2,g=e%2);for(var h=g;h<this._width;h+=f){var i=this._map[h][e],j=this._getNeighbors(h,e);i&&-1!=d.indexOf(j)?b[h][e]=1:i||-1==c.indexOf(j)||(b[h][e]=1)}}if(this._map=b,this._options.connected&&this._completeMaze(),a)for(var e=0;e<this._height;e++){var f=1,g=0;6==this._options.topology&&(f=2,g=e%2);for(var h=g;h<this._width;h+=f)a(h,e,b[h][e])}},d.Map.Cellular.prototype._getNeighbors=function(a,b){for(var c=0,d=0;d<this._dirs.length;d++){
var e=this._dirs[d],f=a+e[0],g=b+e[1];0>f||f>=this._width||0>f||g>=this._width||(c+=1==this._map[f][g]?1:0)}return c},d.Map.Cellular.prototype._completeMaze=function(){for(var a=[],b={},c=0;c<this._width;c++)for(var e=0;e<this._height;e++)if(this._freeSpace(c,e)){var f=[c,e];b[this._pointKey(f)]=f,a.push([c,e])}var g=a[d.RNG.getUniformInt(0,a.length-1)],h=this._pointKey(g),i={};for(i[h]=g,delete b[h],this._findConnected(i,b,[g]);Object.keys(b).length>0;){var f=this._getFromTo(i,b),j=f[0],k=f[1],l={};l[this._pointKey(j)]=j,this._findConnected(l,b,[j],!0),this._tunnelToConnected(k,j,i,b);for(var m in l){var n=l[m];this._map[n[0]][n[1]]=0,i[m]=n,delete b[m]}}},d.Map.Cellular.prototype._getFromTo=function(a,b){for(var c,e,f,g=Object.keys(a),h=Object.keys(b),i=0;5>i;i++){if(g.length<h.length){var j=g;e=a[j[d.RNG.getUniformInt(0,j.length-1)]],c=this._getClosest(e,b)}else{var j=h;c=b[j[d.RNG.getUniformInt(0,j.length-1)]],e=this._getClosest(c,a)}if(f=(c[0]-e[0])*(c[0]-e[0])+(c[1]-e[1])*(c[1]-e[1]),64>f)break}return[c,e]},d.Map.Cellular.prototype._getClosest=function(a,b){var c=null,d=null;for(k in b){var e=b[k],f=(e[0]-a[0])*(e[0]-a[0])+(e[1]-a[1])*(e[1]-a[1]);(null==d||d>f)&&(d=f,c=e)}return c},d.Map.Cellular.prototype._findConnected=function(a,b,c,d){for(;c.length>0;)for(var e=c.splice(0,1)[0],f=[[e[0]+1,e[1]],[e[0]-1,e[1]],[e[0],e[1]+1],[e[0],e[1]-1]],g=0;g<f.length;g++){var h=this._pointKey(f[g]);null==a[h]&&this._freeSpace(f[g][0],f[g][1])&&(a[h]=f[g],d||delete b[h],c.push(f[g]))}},d.Map.Cellular.prototype._tunnelToConnected=function(a,b,c,d){var e,f;this._pointKey(b);b[0]<a[0]?(e=b,f=a):(e=a,f=b);for(var g=e[0];g<=f[0];g++){this._map[g][e[1]]=0;var h=[g,e[1]],i=this._pointKey(h);c[i]=h,delete d[i]}var j=f[0];b[1]<a[1]?(e=b,f=a):(e=a,f=b);for(var k=e[1];k<f[1];k++){this._map[j][k]=0;var h=[j,k],i=this._pointKey(h);c[i]=h,delete d[i]}},d.Map.Cellular.prototype._freeSpace=function(a,b){return a>=0&&a<this._width&&b>=0&&b<this._height&&1!=this._map[a][b]},d.Map.Cellular.prototype._pointKey=function(a){return a[0]+"."+a[1]},d.Map.Dungeon=function(a,b){d.Map.call(this,a,b),this._rooms=[],this._corridors=[]},d.Map.Dungeon.extend(d.Map),d.Map.Dungeon.prototype.getRooms=function(){return this._rooms},d.Map.Dungeon.prototype.getCorridors=function(){return this._corridors},d.Map.Digger=function(a,b,c){d.Map.Dungeon.call(this,a,b),this._options={roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3};for(var e in c)this._options[e]=c[e];this._features={Room:4,Corridor:4},this._featureAttempts=20,this._walls={},this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)},d.Map.Digger.extend(d.Map.Dungeon),d.Map.Digger.prototype.create=function(a){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;var b=(this._width-2)*(this._height-2);this._firstRoom();var c=Date.now();do{var d=Date.now();if(d-c>this._options.timeLimit)break;var e=this._findWall();if(!e)break;var f=e.split(","),g=parseInt(f[0]),h=parseInt(f[1]),i=this._getDiggingDirection(g,h);if(i){var j=0;do if(j++,this._tryFeature(g,h,i[0],i[1])){this._removeSurroundingWalls(g,h),this._removeSurroundingWalls(g-i[0],h-i[1]);break}while(j<this._featureAttempts);var k=0;for(var l in this._walls)this._walls[l]>1&&k++}}while(this._dug/b<this._options.dugPercentage||k);if(this._addDoors(),a)for(var m=0;m<this._width;m++)for(var n=0;n<this._height;n++)a(m,n,this._map[m][n]);return this._walls={},this._map=null,this},d.Map.Digger.prototype._digCallback=function(a,b,c){0==c||2==c?(this._map[a][b]=0,this._dug++):this._walls[a+","+b]=1},d.Map.Digger.prototype._isWallCallback=function(a,b){return 0>a||0>b||a>=this._width||b>=this._height?!1:1==this._map[a][b]},d.Map.Digger.prototype._canBeDugCallback=function(a,b){return 1>a||1>b||a+1>=this._width||b+1>=this._height?!1:1==this._map[a][b]},d.Map.Digger.prototype._priorityWallCallback=function(a,b){this._walls[a+","+b]=2},d.Map.Digger.prototype._firstRoom=function(){var a=Math.floor(this._width/2),b=Math.floor(this._height/2),c=d.Map.Feature.Room.createRandomCenter(a,b,this._options);this._rooms.push(c),c.create(this._digCallback)},d.Map.Digger.prototype._findWall=function(){var a=[],b=[];for(var c in this._walls){var d=this._walls[c];2==d?b.push(c):a.push(c)}var e=b.length?b:a;if(!e.length)return null;var c=e.random();return delete this._walls[c],c},d.Map.Digger.prototype._tryFeature=function(a,b,c,e){var f=d.RNG.getWeightedValue(this._features);return f=d.Map.Feature[f].createRandomAt(a,b,c,e,this._options),f.isValid(this._isWallCallback,this._canBeDugCallback)?(f.create(this._digCallback),f instanceof d.Map.Feature.Room&&this._rooms.push(f),f instanceof d.Map.Feature.Corridor&&(f.createPriorityWalls(this._priorityWallCallback),this._corridors.push(f)),!0):!1},d.Map.Digger.prototype._removeSurroundingWalls=function(a,b){for(var c=d.DIRS[4],e=0;e<c.length;e++){var f=c[e],g=a+f[0],h=b+f[1];delete this._walls[g+","+h];var g=a+2*f[0],h=b+2*f[1];delete this._walls[g+","+h]}},d.Map.Digger.prototype._getDiggingDirection=function(a,b){if(0>=a||0>=b||a>=this._width-1||b>=this._height-1)return null;for(var c=null,e=d.DIRS[4],f=0;f<e.length;f++){var g=e[f],h=a+g[0],i=b+g[1];if(!this._map[h][i]){if(c)return null;c=g}}return c?[-c[0],-c[1]]:null},d.Map.Digger.prototype._addDoors=function(){for(var a=this._map,b=function(b,c){return 1==a[b][c]},c=0;c<this._rooms.length;c++){var d=this._rooms[c];d.clearDoors(),d.addDoors(b)}},d.Map.Uniform=function(a,b,c){d.Map.Dungeon.call(this,a,b),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3};for(var e in c)this._options[e]=c[e];this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)},d.Map.Uniform.extend(d.Map.Dungeon),d.Map.Uniform.prototype.create=function(a){for(var b=Date.now();;){var c=Date.now();if(c-b>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),!(this._rooms.length<2)&&this._generateCorridors())break}if(a)for(var d=0;d<this._width;d++)for(var e=0;e<this._height;e++)a(d,e,this._map[d][e]);return this},d.Map.Uniform.prototype._generateRooms=function(){var a=this._width-2,b=this._height-2;do{var c=this._generateRoom();if(this._dug/(a*b)>this._options.roomDugPercentage)break}while(c)},d.Map.Uniform.prototype._generateRoom=function(){for(var a=0;a<this._roomAttempts;){a++;var b=d.Map.Feature.Room.createRandom(this._width,this._height,this._options);if(b.isValid(this._isWallCallback,this._canBeDugCallback))return b.create(this._digCallback),this._rooms.push(b),b}return null},d.Map.Uniform.prototype._generateCorridors=function(){for(var a=0;a<this._corridorAttempts;){a++,this._corridors=[],this._map=this._fillMap(1);for(var b=0;b<this._rooms.length;b++){var c=this._rooms[b];c.clearDoors(),c.create(this._digCallback)}for(this._unconnected=this._rooms.slice().randomize(),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){var d=this._connected.random(),e=this._closestRoom(this._unconnected,d),f=this._closestRoom(this._connected,e),g=this._connectRooms(e,f);if(!g)break;if(!this._unconnected.length)return!0}}return!1},d.Map.Uniform.prototype._closestRoom=function(a,b){for(var c=1/0,d=b.getCenter(),e=null,f=0;f<a.length;f++){var g=a[f],h=g.getCenter(),i=h[0]-d[0],j=h[1]-d[1],k=i*i+j*j;c>k&&(c=k,e=g)}return e},d.Map.Uniform.prototype._connectRooms=function(a,b){var c=a.getCenter(),d=b.getCenter(),e=d[0]-c[0],f=d[1]-c[1];if(Math.abs(e)<Math.abs(f))var g=f>0?2:0,h=(g+2)%4,i=b.getLeft(),j=b.getRight(),k=0;else var g=e>0?1:3,h=(g+2)%4,i=b.getTop(),j=b.getBottom(),k=1;var l=this._placeInWall(a,g);if(!l)return!1;if(l[k]>=i&&l[k]<=j){var m=l.slice(),n=null;switch(h){case 0:n=b.getTop()-1;break;case 1:n=b.getRight()+1;break;case 2:n=b.getBottom()+1;break;case 3:n=b.getLeft()-1}m[(k+1)%2]=n,this._digLine([l,m])}else if(l[k]<i-1||l[k]>j+1){var o=l[k]-d[k];switch(h){case 0:case 1:var p=0>o?3:1;break;case 2:case 3:var p=0>o?1:3}h=(h+p)%4;var m=this._placeInWall(b,h);if(!m)return!1;var q=[0,0];q[k]=l[k];var r=(k+1)%2;q[r]=m[r],this._digLine([l,q,m])}else{var r=(k+1)%2,m=this._placeInWall(b,h);if(!m)return!1;var q=Math.round((m[r]+l[r])/2),s=[0,0],t=[0,0];s[k]=l[k],s[r]=q,t[k]=m[k],t[r]=q,this._digLine([l,s,t,m])}a.addDoor(l[0],l[1]),b.addDoor(m[0],m[1]);var k=this._unconnected.indexOf(a);-1!=k&&(this._unconnected.splice(k,1),this._connected.push(a));var k=this._unconnected.indexOf(b);return-1!=k&&(this._unconnected.splice(k,1),this._connected.push(b)),!0},d.Map.Uniform.prototype._placeInWall=function(a,b){var c=[0,0],d=[0,0],e=0;switch(b){case 0:d=[1,0],c=[a.getLeft(),a.getTop()-1],e=a.getRight()-a.getLeft()+1;break;case 1:d=[0,1],c=[a.getRight()+1,a.getTop()],e=a.getBottom()-a.getTop()+1;break;case 2:d=[1,0],c=[a.getLeft(),a.getBottom()+1],e=a.getRight()-a.getLeft()+1;break;case 3:d=[0,1],c=[a.getLeft()-1,a.getTop()],e=a.getBottom()-a.getTop()+1}for(var f=[],g=-2,h=0;e>h;h++){var i=c[0]+h*d[0],j=c[1]+h*d[1];f.push(null);var k=1==this._map[i][j];k?g!=h-1&&(f[h]=[i,j]):(g=h,h&&(f[h-1]=null))}for(var h=f.length-1;h>=0;h--)f[h]||f.splice(h,1);return f.length?f.random():null},d.Map.Uniform.prototype._digLine=function(a){for(var b=1;b<a.length;b++){var c=a[b-1],e=a[b],f=new d.Map.Feature.Corridor(c[0],c[1],e[0],e[1]);f.create(this._digCallback),this._corridors.push(f)}},d.Map.Uniform.prototype._digCallback=function(a,b,c){this._map[a][b]=c,0==c&&this._dug++},d.Map.Uniform.prototype._isWallCallback=function(a,b){return 0>a||0>b||a>=this._width||b>=this._height?!1:1==this._map[a][b]},d.Map.Uniform.prototype._canBeDugCallback=function(a,b){return 1>a||1>b||a+1>=this._width||b+1>=this._height?!1:1==this._map[a][b]},d.Map.Rogue=function(a,b,c){d.Map.call(this,a,b),this._options={cellWidth:3,cellHeight:3};for(var e in c)this._options[e]=c[e];this._options.hasOwnProperty("roomWidth")||(this._options.roomWidth=this._calculateRoomSize(this._width,this._options.cellWidth)),this._options.hasOwnProperty("roomHeight")||(this._options.roomHeight=this._calculateRoomSize(this._height,this._options.cellHeight))},d.Map.Rogue.extend(d.Map),d.Map.Rogue.prototype.create=function(a){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),a)for(var b=0;b<this._width;b++)for(var c=0;c<this._height;c++)a(b,c,this.map[b][c]);return this},d.Map.Rogue.prototype._calculateRoomSize=function(a,b){var c=Math.floor(a/b*.8),d=Math.floor(a/b*.25);return 2>d&&(d=2),2>c&&(c=2),[d,c]},d.Map.Rogue.prototype._initRooms=function(){for(var a=0;a<this._options.cellWidth;a++){this.rooms.push([]);for(var b=0;b<this._options.cellHeight;b++)this.rooms[a].push({x:0,y:0,width:0,height:0,connections:[],cellx:a,celly:b})}},d.Map.Rogue.prototype._connectRooms=function(){var a,b,c,e,f,g=d.RNG.getUniformInt(0,this._options.cellWidth-1),h=d.RNG.getUniformInt(0,this._options.cellHeight-1),i=!1;do{var j=[0,2,4,6];j=j.randomize();do if(i=!1,a=j.pop(),b=g+d.DIRS[8][a][0],c=h+d.DIRS[8][a][1],!(0>b||b>=this._options.cellWidth||0>c||c>=this._options.cellHeight)){if(e=this.rooms[g][h],e.connections.length>0&&e.connections[0][0]==b&&e.connections[0][1]==c)break;f=this.rooms[b][c],0==f.connections.length&&(f.connections.push([g,h]),this.connectedCells.push([b,c]),g=b,h=c,i=!0)}while(j.length>0&&0==i)}while(j.length>0)},d.Map.Rogue.prototype._connectUnconnectedRooms=function(){var a=this._options.cellWidth,b=this._options.cellHeight;this.connectedCells=this.connectedCells.randomize();for(var c,e,f,g=0;g<this._options.cellWidth;g++)for(var h=0;h<this._options.cellHeight;h++)if(c=this.rooms[g][h],0==c.connections.length){var i=[0,2,4,6];i=i.randomize();var f=!1;do{var j=i.pop(),k=g+d.DIRS[8][j][0],l=h+d.DIRS[8][j][1];if(!(0>k||k>=a||0>l||l>=b)){if(e=this.rooms[k][l],f=!0,0==e.connections.length)break;for(var m=0;m<e.connections.length;m++)if(e.connections[m][0]==g&&e.connections[m][1]==h){f=!1;break}if(f)break}}while(i.length);f&&c.connections.push([e.cellx,e.celly])}},d.Map.Rogue.prototype._createRandomRoomConnections=function(a){},d.Map.Rogue.prototype._createRooms=function(){for(var a,b,c,e,f,g=this._width,h=this._height,i=this._options.cellWidth,j=this._options.cellHeight,k=Math.floor(this._width/i),l=Math.floor(this._height/j),m=this._options.roomWidth,n=this._options.roomHeight,o=0;i>o;o++)for(var p=0;j>p;p++){if(c=k*o,e=l*p,0==c&&(c=1),0==e&&(e=1),a=d.RNG.getUniformInt(m[0],m[1]),b=d.RNG.getUniformInt(n[0],n[1]),p>0)for(f=this.rooms[o][p-1];e-(f.y+f.height)<3;)e++;if(o>0)for(f=this.rooms[o-1][p];c-(f.x+f.width)<3;)c++;for(var q=Math.round(d.RNG.getUniformInt(0,k-a)/2),r=Math.round(d.RNG.getUniformInt(0,l-b)/2);c+q+a>=g;)q?q--:a--;for(;e+r+b>=h;)r?r--:b--;c+=q,e+=r,this.rooms[o][p].x=c,this.rooms[o][p].y=e,this.rooms[o][p].width=a,this.rooms[o][p].height=b;for(var s=c;c+a>s;s++)for(var t=e;e+b>t;t++)this.map[s][t]=0}},d.Map.Rogue.prototype._getWallPosition=function(a,b){var c,e,f;return 1==b||3==b?(c=d.RNG.getUniformInt(a.x+1,a.x+a.width-2),1==b?(e=a.y-2,f=e+1):(e=a.y+a.height+1,f=e-1),this.map[c][f]=0):(2==b||4==b)&&(e=d.RNG.getUniformInt(a.y+1,a.y+a.height-2),2==b?(c=a.x+a.width+1,f=c-1):(c=a.x-2,f=c+1),this.map[f][e]=0),[c,e]},d.Map.Rogue.prototype._drawCorridore=function(a,b){var c,e,f,g,h=b[0]-a[0],i=b[1]-a[1],j=a[0],k=a[1],l=[],m=Math.abs(h),n=Math.abs(i),o=d.RNG.getUniform(),p=o,q=1-o;for(e=h>0?2:6,f=i>0?4:0,n>m?(c=Math.ceil(n*p),l.push([f,c]),l.push([e,m]),c=Math.floor(n*q),l.push([f,c])):(c=Math.ceil(m*p),l.push([e,c]),l.push([f,n]),c=Math.floor(m*q),l.push([e,c])),this.map[j][k]=0;l.length>0;)for(g=l.pop();g[1]>0;)j+=d.DIRS[8][g[0]][0],k+=d.DIRS[8][g[0]][1],this.map[j][k]=0,g[1]=g[1]-1},d.Map.Rogue.prototype._createCorridors=function(){for(var a,b,c,d,e,f=this._options.cellWidth,g=this._options.cellHeight,h=0;f>h;h++)for(var i=0;g>i;i++){a=this.rooms[h][i];for(var j=0;j<a.connections.length;j++)b=a.connections[j],c=this.rooms[b[0]][b[1]],c.cellx>a.cellx?(d=2,e=4):c.cellx<a.cellx?(d=4,e=2):c.celly>a.celly?(d=3,e=1):c.celly<a.celly&&(d=1,e=3),this._drawCorridore(this._getWallPosition(a,d),this._getWallPosition(c,e))}},d.Map.Feature=function(){},d.Map.Feature.prototype.isValid=function(a){},d.Map.Feature.prototype.create=function(a){},d.Map.Feature.prototype.debug=function(){},d.Map.Feature.createRandomAt=function(a,b,c,d,e){},d.Map.Feature.Room=function(a,b,c,d,e,f){this._x1=a,this._y1=b,this._x2=c,this._y2=d,this._doors={},arguments.length>4&&this.addDoor(e,f)},d.Map.Feature.Room.extend(d.Map.Feature),d.Map.Feature.Room.createRandomAt=function(a,b,c,e,f){var g=f.roomWidth[0],h=f.roomWidth[1],i=d.RNG.getUniformInt(g,h),g=f.roomHeight[0],h=f.roomHeight[1],j=d.RNG.getUniformInt(g,h);if(1==c){var k=b-Math.floor(d.RNG.getUniform()*j);return new this(a+1,k,a+i,k+j-1,a,b)}if(-1==c){var k=b-Math.floor(d.RNG.getUniform()*j);return new this(a-i,k,a-1,k+j-1,a,b)}if(1==e){var l=a-Math.floor(d.RNG.getUniform()*i);return new this(l,b+1,l+i-1,b+j,a,b)}if(-1==e){var l=a-Math.floor(d.RNG.getUniform()*i);return new this(l,b-j,l+i-1,b-1,a,b)}throw new Error("dx or dy must be 1 or -1")},d.Map.Feature.Room.createRandomCenter=function(a,b,c){var e=c.roomWidth[0],f=c.roomWidth[1],g=d.RNG.getUniformInt(e,f),e=c.roomHeight[0],f=c.roomHeight[1],h=d.RNG.getUniformInt(e,f),i=a-Math.floor(d.RNG.getUniform()*g),j=b-Math.floor(d.RNG.getUniform()*h),k=i+g-1,l=j+h-1;return new this(i,j,k,l)},d.Map.Feature.Room.createRandom=function(a,b,c){var e=c.roomWidth[0],f=c.roomWidth[1],g=d.RNG.getUniformInt(e,f),e=c.roomHeight[0],f=c.roomHeight[1],h=d.RNG.getUniformInt(e,f),i=a-g-1,j=b-h-1,k=1+Math.floor(d.RNG.getUniform()*i),l=1+Math.floor(d.RNG.getUniform()*j),m=k+g-1,n=l+h-1;return new this(k,l,m,n)},d.Map.Feature.Room.prototype.addDoor=function(a,b){return this._doors[a+","+b]=1,this},d.Map.Feature.Room.prototype.getDoors=function(a){for(var b in this._doors){var c=b.split(",");a(parseInt(c[0]),parseInt(c[1]))}return this},d.Map.Feature.Room.prototype.clearDoors=function(){return this._doors={},this},d.Map.Feature.Room.prototype.addDoors=function(a){for(var b=this._x1-1,c=this._x2+1,d=this._y1-1,e=this._y2+1,f=b;c>=f;f++)for(var g=d;e>=g;g++)(f==b||f==c||g==d||g==e)&&(a(f,g)||this.addDoor(f,g));return this},d.Map.Feature.Room.prototype.debug=function(){},d.Map.Feature.Room.prototype.isValid=function(a,b){for(var c=this._x1-1,d=this._x2+1,e=this._y1-1,f=this._y2+1,g=c;d>=g;g++)for(var h=e;f>=h;h++)if(g==c||g==d||h==e||h==f){if(!a(g,h))return!1}else if(!b(g,h))return!1;return!0},d.Map.Feature.Room.prototype.create=function(a){for(var b=this._x1-1,c=this._x2+1,d=this._y1-1,e=this._y2+1,f=0,g=b;c>=g;g++)for(var h=d;e>=h;h++)f=g+","+h in this._doors?2:g==b||g==c||h==d||h==e?1:0,a(g,h,f)},d.Map.Feature.Room.prototype.getCenter=function(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]},d.Map.Feature.Room.prototype.getLeft=function(){return this._x1},d.Map.Feature.Room.prototype.getRight=function(){return this._x2},d.Map.Feature.Room.prototype.getTop=function(){return this._y1},d.Map.Feature.Room.prototype.getBottom=function(){return this._y2},d.Map.Feature.Corridor=function(a,b,c,d){this._startX=a,this._startY=b,this._endX=c,this._endY=d,this._endsWithAWall=!0},d.Map.Feature.Corridor.extend(d.Map.Feature),d.Map.Feature.Corridor.createRandomAt=function(a,b,c,e,f){var g=f.corridorLength[0],h=f.corridorLength[1],i=d.RNG.getUniformInt(g,h);return new this(a,b,a+c*i,b+e*i)},d.Map.Feature.Corridor.prototype.debug=function(){},d.Map.Feature.Corridor.prototype.isValid=function(a,b){var c=this._startX,d=this._startY,e=this._endX-c,f=this._endY-d,g=1+Math.max(Math.abs(e),Math.abs(f));e&&(e/=Math.abs(e)),f&&(f/=Math.abs(f));for(var h=f,i=-e,j=!0,k=0;g>k;k++){var l=c+k*e,m=d+k*f;if(b(l,m)||(j=!1),a(l+h,m+i)||(j=!1),a(l-h,m-i)||(j=!1),!j){g=k,this._endX=l-e,this._endY=m-f;break}}if(0==g)return!1;if(1==g&&a(this._endX+e,this._endY+f))return!1;var n=!a(this._endX+e+h,this._endY+f+i),o=!a(this._endX+e-h,this._endY+f-i);return this._endsWithAWall=a(this._endX+e,this._endY+f),(n||o)&&this._endsWithAWall?!1:!0},d.Map.Feature.Corridor.prototype.create=function(a){var b=this._startX,c=this._startY,d=this._endX-b,e=this._endY-c,f=1+Math.max(Math.abs(d),Math.abs(e));d&&(d/=Math.abs(d)),e&&(e/=Math.abs(e));for(var g=0;f>g;g++){var h=b+g*d,i=c+g*e;a(h,i,0)}return!0},d.Map.Feature.Corridor.prototype.createPriorityWalls=function(a){if(this._endsWithAWall){var b=this._startX,c=this._startY,d=this._endX-b,e=this._endY-c;d&&(d/=Math.abs(d)),e&&(e/=Math.abs(e));var f=e,g=-d;a(this._endX+d,this._endY+e),a(this._endX+f,this._endY+g),a(this._endX-f,this._endY-g)}},d.Noise=function(){},d.Noise.prototype.get=function(a,b){},d.Noise.Simplex=function(a){d.Noise.call(this),this._F2=.5*(Math.sqrt(3)-1),this._G2=(3-Math.sqrt(3))/6,this._gradients=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];for(var b=[],c=a||256,e=0;c>e;e++)b.push(e);b=b.randomize(),this._perms=[],this._indexes=[];for(var e=0;2*c>e;e++)this._perms.push(b[e%c]),this._indexes.push(this._perms[e]%this._gradients.length)},d.Noise.Simplex.extend(d.Noise),d.Noise.Simplex.prototype.get=function(a,b){var c,d,e,f=this._perms,g=this._indexes,h=f.length/2,i=this._G2,j=0,k=0,l=0,m=(a+b)*this._F2,n=Math.floor(a+m),o=Math.floor(b+m),p=(n+o)*i,q=n-p,r=o-p,s=a-q,t=b-r;s>t?(d=1,e=0):(d=0,e=1);var u=s-d+i,v=t-e+i,w=s-1+2*i,x=t-1+2*i,y=n.mod(h),z=o.mod(h),A=.5-s*s-t*t;if(A>=0){A*=A,c=g[y+f[z]];var B=this._gradients[c];j=A*A*(B[0]*s+B[1]*t)}var C=.5-u*u-v*v;if(C>=0){C*=C,c=g[y+d+f[z+e]];var B=this._gradients[c];k=C*C*(B[0]*u+B[1]*v)}var D=.5-w*w-x*x;if(D>=0){D*=D,c=g[y+1+f[z+1]];var B=this._gradients[c];l=D*D*(B[0]*w+B[1]*x)}return 70*(j+k+l)},d.FOV=function(a,b){this._lightPasses=a,this._options={topology:8};for(var c in b)this._options[c]=b[c]},d.FOV.prototype.compute=function(a,b,c,d){},d.FOV.prototype._getCircle=function(a,b,c){var e,f,g,h=[];switch(this._options.topology){case 4:f=1,g=[0,1],e=[d.DIRS[8][7],d.DIRS[8][1],d.DIRS[8][3],d.DIRS[8][5]];break;case 6:e=d.DIRS[6],f=1,g=[-1,1];break;case 8:e=d.DIRS[4],f=2,g=[-1,1]}for(var i=a+g[0]*c,j=b+g[1]*c,k=0;k<e.length;k++)for(var l=0;c*f>l;l++)h.push([i,j]),i+=e[k][0],j+=e[k][1];return h},d.FOV.DiscreteShadowcasting=function(a,b){d.FOV.call(this,a,b)},d.FOV.DiscreteShadowcasting.extend(d.FOV),d.FOV.DiscreteShadowcasting.prototype.compute=function(a,b,c,d){this._coords,this._map;if(d(a,b,0,1),this._lightPasses(a,b))for(var e,f,g,h,i,j=[],k=1;c>=k;k++)for(var l=this._getCircle(a,b,k),m=360/l.length,n=0;n<l.length;n++)if(g=l[n][0],h=l[n][1],e=m*(n-.5),f=e+m,i=!this._lightPasses(g,h),this._visibleCoords(Math.floor(e),Math.ceil(f),i,j)&&d(g,h,k,1),2==j.length&&0==j[0]&&360==j[1])return},d.FOV.DiscreteShadowcasting.prototype._visibleCoords=function(a,b,c,d){if(0>a){var e=arguments.callee(0,b,c,d),f=arguments.callee(360+a,360,c,d);return e||f}for(var g=0;g<d.length&&d[g]<a;)g++;if(g==d.length)return c&&d.push(a,b),!0;var h=0;if(g%2){for(;g<d.length&&d[g]<b;)g++,h++;return 0==h?!1:(c&&(h%2?d.splice(g-h,h,b):d.splice(g-h,h)),!0)}for(;g<d.length&&d[g]<b;)g++,h++;return a==d[g-h]&&1==h?!1:(c&&(h%2?d.splice(g-h,h,a):d.splice(g-h,h,a,b)),!0)},d.FOV.PreciseShadowcasting=function(a,b){d.FOV.call(this,a,b)},d.FOV.PreciseShadowcasting.extend(d.FOV),d.FOV.PreciseShadowcasting.prototype.compute=function(a,b,c,d){if(d(a,b,0,1),this._lightPasses(a,b))for(var e,f,g,h,i,j,k=[],l=1;c>=l;l++)for(var m=this._getCircle(a,b,l),n=m.length,o=0;n>o;o++)if(e=m[o][0],f=m[o][1],h=[o?2*o-1:2*n-1,2*n],i=[2*o+1,2*n],g=!this._lightPasses(e,f),j=this._checkVisibility(h,i,g,k),j&&d(e,f,l,j),2==k.length&&0==k[0][0]&&k[1][0]==k[1][1])return},d.FOV.PreciseShadowcasting.prototype._checkVisibility=function(a,b,c,d){if(a[0]>b[0]){var e=this._checkVisibility(a,[a[1],a[1]],c,d),f=this._checkVisibility([0,1],b,c,d);return(e+f)/2}for(var g=0,h=!1;g<d.length;){var i=d[g],j=i[0]*a[1]-a[0]*i[1];if(j>=0){0!=j||g%2||(h=!0);break}g++}for(var k=d.length,l=!1;k--;){var i=d[k],j=b[0]*i[1]-i[0]*b[1];if(j>=0){0==j&&k%2&&(l=!0);break}}var m=!0;if(g==k&&(h||l)?m=!1:h&&l&&g+1==k&&k%2?m=!1:g>k&&g%2&&(m=!1),!m)return 0;var n,o,p=k-g+1;if(p%2)if(g%2){var o=d[g];n=(b[0]*o[1]-o[0]*b[1])/(o[1]*b[1]),c&&d.splice(g,p,b)}else{var o=d[k];n=(o[0]*a[1]-a[0]*o[1])/(a[1]*o[1]),c&&d.splice(g,p,a)}else{if(!(g%2))return c&&d.splice(g,p,a,b),1;var q=d[g],r=d[k];n=(r[0]*q[1]-q[0]*r[1])/(q[1]*r[1]),c&&d.splice(g,p)}var s=(b[0]*a[1]-a[0]*b[1])/(a[1]*b[1]);return n/s},d.FOV.RecursiveShadowcasting=function(a,b){d.FOV.call(this,a,b)},d.FOV.RecursiveShadowcasting.extend(d.FOV),d.FOV.RecursiveShadowcasting.OCTANTS=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]],d.FOV.RecursiveShadowcasting.prototype.compute=function(a,b,c,e){e(a,b,0,1);for(var f=0;f<d.FOV.RecursiveShadowcasting.OCTANTS.length;f++)this._renderOctant(a,b,d.FOV.RecursiveShadowcasting.OCTANTS[f],c,e)},d.FOV.RecursiveShadowcasting.prototype.compute180=function(a,b,c,e,f){f(a,b,0,1);var g=(e-1+8)%8,h=(e-2+8)%8,i=(e+1+8)%8;this._renderOctant(a,b,d.FOV.RecursiveShadowcasting.OCTANTS[h],c,f),this._renderOctant(a,b,d.FOV.RecursiveShadowcasting.OCTANTS[g],c,f),this._renderOctant(a,b,d.FOV.RecursiveShadowcasting.OCTANTS[e],c,f),this._renderOctant(a,b,d.FOV.RecursiveShadowcasting.OCTANTS[i],c,f)},d.FOV.RecursiveShadowcasting.prototype.compute90=function(a,b,c,e,f){f(a,b,0,1);var g=(e-1+8)%8;this._renderOctant(a,b,d.FOV.RecursiveShadowcasting.OCTANTS[e],c,f),this._renderOctant(a,b,d.FOV.RecursiveShadowcasting.OCTANTS[g],c,f)},d.FOV.RecursiveShadowcasting.prototype._renderOctant=function(a,b,c,d,e){this._castVisibility(a,b,1,1,0,d+1,c[0],c[1],c[2],c[3],e)},d.FOV.RecursiveShadowcasting.prototype._castVisibility=function(a,b,c,d,e,f,g,h,i,j,k){if(!(e>d))for(var l=c;f>=l;l++){for(var m=-l-1,n=-l,o=!1,p=0;0>=m;){m+=1;var q=a+m*g+n*h,r=b+m*i+n*j,s=(m-.5)/(n+.5),t=(m+.5)/(n-.5);if(!(t>d)){if(e>s)break;if(f*f>m*m+n*n&&k(q,r,l,1),o){if(!this._lightPasses(q,r)){p=t;continue}o=!1,d=p}else!this._lightPasses(q,r)&&f>l&&(o=!0,this._castVisibility(a,b,l+1,d,s,f,g,h,i,j,k),p=t)}}if(o)break}},d.Color={fromString:function(a){var b,c;if(a in this._cache)b=this._cache[a];else{if("#"==a.charAt(0)){var d=a.match(/[0-9a-f]/gi).map(function(a){return parseInt(a,16)});if(3==d.length)b=d.map(function(a){return 17*a});else{for(var e=0;3>e;e++)d[e+1]+=16*d[e],d.splice(e,1);b=d}}else b=(c=a.match(/rgb\(([0-9, ]+)\)/i))?c[1].split(/\s*,\s*/).map(function(a){return parseInt(a)}):[0,0,0];this._cache[a]=b}return b.slice()},add:function(a,b){for(var c=a.slice(),d=0;3>d;d++)for(var e=1;e<arguments.length;e++)c[d]+=arguments[e][d];return c},add_:function(a,b){for(var c=0;3>c;c++)for(var d=1;d<arguments.length;d++)a[c]+=arguments[d][c];return a},multiply:function(a,b){for(var c=a.slice(),d=0;3>d;d++){for(var e=1;e<arguments.length;e++)c[d]*=arguments[e][d]/255;c[d]=Math.round(c[d])}return c},multiply_:function(a,b){for(var c=0;3>c;c++){for(var d=1;d<arguments.length;d++)a[c]*=arguments[d][c]/255;a[c]=Math.round(a[c])}return a},interpolate:function(a,b,c){arguments.length<3&&(c=.5);for(var d=a.slice(),e=0;3>e;e++)d[e]=Math.round(d[e]+c*(b[e]-a[e]));return d},interpolateHSL:function(a,b,c){arguments.length<3&&(c=.5);for(var d=this.rgb2hsl(a),e=this.rgb2hsl(b),f=0;3>f;f++)d[f]+=c*(e[f]-d[f]);return this.hsl2rgb(d)},randomize:function(a,b){b instanceof Array||(b=Math.round(d.RNG.getNormal(0,b)));for(var c=a.slice(),e=0;3>e;e++)c[e]+=b instanceof Array?Math.round(d.RNG.getNormal(0,b[e])):b;return c},rgb2hsl:function(a){var b,c,d=a[0]/255,e=a[1]/255,f=a[2]/255,g=Math.max(d,e,f),h=Math.min(d,e,f),i=(g+h)/2;if(g==h)b=c=0;else{var j=g-h;switch(c=i>.5?j/(2-g-h):j/(g+h),g){case d:b=(e-f)/j+(f>e?6:0);break;case e:b=(f-d)/j+2;break;case f:b=(d-e)/j+4}b/=6}return[b,c,i]},hsl2rgb:function(a){var b=a[2];if(0==a[1])return b=Math.round(255*b),[b,b,b];var c=function(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a},d=a[1],e=.5>b?b*(1+d):b+d-b*d,f=2*b-e,g=c(f,e,a[0]+1/3),h=c(f,e,a[0]),i=c(f,e,a[0]-1/3);return[Math.round(255*g),Math.round(255*h),Math.round(255*i)]},toRGB:function(a){return"rgb("+this._clamp(a[0])+","+this._clamp(a[1])+","+this._clamp(a[2])+")"},toHex:function(a){for(var b=[],c=0;3>c;c++)b.push(this._clamp(a[c]).toString(16).lpad("0",2));return"#"+b.join("")},_clamp:function(a){return 0>a?0:a>255?255:a},_cache:{black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]}},d.Lighting=function(a,b){this._reflectivityCallback=a,this._options={passes:1,emissionThreshold:100,range:10},this._fov=null,this._lights={},this._reflectivityCache={},this._fovCache={},this.setOptions(b)},d.Lighting.prototype.setOptions=function(a){for(var b in a)this._options[b]=a[b];return a&&a.range&&this.reset(),this},d.Lighting.prototype.setFOV=function(a){return this._fov=a,this._fovCache={},this},d.Lighting.prototype.setLight=function(a,b,c){var e=a+","+b;return c?this._lights[e]="string"==typeof c?d.Color.fromString(c):c:delete this._lights[e],this},d.Lighting.prototype.clearLights=function(){this._lights={}},d.Lighting.prototype.reset=function(){return this._reflectivityCache={},this._fovCache={},this},d.Lighting.prototype.compute=function(a){var b={},c={},e={};for(var f in this._lights){var g=this._lights[f];c[f]=[0,0,0],d.Color.add_(c[f],g)}for(var h=0;h<this._options.passes;h++)this._emitLight(c,e,b),h+1!=this._options.passes&&(c=this._computeEmitters(e,b));for(var i in e){var j=i.split(","),k=parseInt(j[0]),l=parseInt(j[1]);a(k,l,e[i])}return this},d.Lighting.prototype._emitLight=function(a,b,c){for(var d in a){var e=d.split(","),f=parseInt(e[0]),g=parseInt(e[1]);this._emitLightFromCell(f,g,a[d],b),c[d]=1}return this},d.Lighting.prototype._computeEmitters=function(a,b){var c={};for(var d in a)if(!(d in b)){var e=a[d];if(d in this._reflectivityCache)var f=this._reflectivityCache[d];else{var g=d.split(","),h=parseInt(g[0]),i=parseInt(g[1]),f=this._reflectivityCallback(h,i);this._reflectivityCache[d]=f}if(0!=f){for(var j=[],k=0,l=0;3>l;l++){var m=Math.round(e[l]*f);j[l]=m,k+=m}k>this._options.emissionThreshold&&(c[d]=j)}}return c},d.Lighting.prototype._emitLightFromCell=function(a,b,c,d){var e=a+","+b;if(e in this._fovCache)var f=this._fovCache[e];else var f=this._updateFOV(a,b);for(var g in f){var h=f[g];if(g in d)var i=d[g];else{var i=[0,0,0];d[g]=i}for(var j=0;3>j;j++)i[j]+=Math.round(c[j]*h);
}return this},d.Lighting.prototype._updateFOV=function(a,b){var c=a+","+b,d={};this._fovCache[c]=d;var e=this._options.range,f=function(a,b,c,f){var g=a+","+b,h=f*(1-c/e);0!=h&&(d[g]=h)};return this._fov.compute(a,b,e,f.bind(this)),d},d.Path=function(a,b,c,e){this._toX=a,this._toY=b,this._fromX=null,this._fromY=null,this._passableCallback=c,this._options={topology:8};for(var f in e)this._options[f]=e[f];this._dirs=d.DIRS[this._options.topology],8==this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])},d.Path.prototype.compute=function(a,b,c){},d.Path.prototype._getNeighbors=function(a,b){for(var c=[],d=0;d<this._dirs.length;d++){var e=this._dirs[d],f=a+e[0],g=b+e[1];this._passableCallback(f,g)&&c.push([f,g])}return c},d.Path.Dijkstra=function(a,b,c,e){d.Path.call(this,a,b,c,e),this._computed={},this._todo=[],this._add(a,b,null)},d.Path.Dijkstra.extend(d.Path),d.Path.Dijkstra.prototype.compute=function(a,b,c){var d=a+","+b;if(d in this._computed||this._compute(a,b),d in this._computed)for(var e=this._computed[d];e;)c(e.x,e.y),e=e.prev},d.Path.Dijkstra.prototype._compute=function(a,b){for(;this._todo.length;){var c=this._todo.shift();if(c.x==a&&c.y==b)return;for(var d=this._getNeighbors(c.x,c.y),e=0;e<d.length;e++){var f=d[e],g=f[0],h=f[1],i=g+","+h;i in this._computed||this._add(g,h,c)}}},d.Path.Dijkstra.prototype._add=function(a,b,c){var d={x:a,y:b,prev:c};this._computed[a+","+b]=d,this._todo.push(d)},d.Path.AStar=function(a,b,c,e){d.Path.call(this,a,b,c,e),this._todo=[],this._done={},this._fromX=null,this._fromY=null},d.Path.AStar.extend(d.Path),d.Path.AStar.prototype.compute=function(a,b,c){for(this._todo=[],this._done={},this._fromX=a,this._fromY=b,this._add(this._toX,this._toY,null);this._todo.length;){var d=this._todo.shift();if(d.x==a&&d.y==b)break;for(var e=this._getNeighbors(d.x,d.y),f=0;f<e.length;f++){var g=e[f],h=g[0],i=g[1],j=h+","+i;j in this._done||this._add(h,i,d)}}var d=this._done[a+","+b];if(d)for(;d;)c(d.x,d.y),d=d.prev},d.Path.AStar.prototype._add=function(a,b,c){var d={x:a,y:b,prev:c,g:c?c.g+1:0,h:this._distance(a,b)};this._done[a+","+b]=d;for(var e=d.g+d.h,f=0;f<this._todo.length;f++){var g=this._todo[f];if(e<g.g+g.h)return void this._todo.splice(f,0,d)}this._todo.push(d)},d.Path.AStar.prototype._distance=function(a,b){switch(this._options.topology){case 4:return Math.abs(a-this._fromX)+Math.abs(b-this._fromY);case 6:var c=Math.abs(a-this._fromX),d=Math.abs(b-this._fromY);return d+Math.max(0,(c-d)/2);case 8:return Math.max(Math.abs(a-this._fromX),Math.abs(b-this._fromY))}throw new Error("Illegal topology")},b.exports=d},{}]},{},[1]);